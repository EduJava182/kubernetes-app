# ==========================================================
#      CONFIGURAÇÃO GLOBAL — IMAGEM PADRÃO DO PIPELINE
# ==========================================================
# A imagem global será usada apenas quando o job não definir a sua.
image: docker:latest

stages:
  - build
  - test
  - package
  - deploy

# ==========================================================
#                          BUILD
# ==========================================================
build:
  stage: build
  image: maven:3.9.6-eclipse-temurin-17

  before_script:
    - echo "Java instalado:"
    - java -version           # confirma versão do Java
    - echo "Maven instalado:"
    - mvn -version            # confirma versão do Maven

  script:
    - echo "Atualizando versão automaticamente..."
    # Atualiza a versão no pom.xml para um valor único por pipeline/commit
    - mvn versions:set -DnewVersion=1.0.$CI_PIPELINE_IID-$CI_COMMIT_SHORT_SHA
    # Limpa e empacota o projeto sem executar testes
    - mvn clean package -DskipTests

  artifacts:
    paths:
      - target/*.jar
      - pom.xml

# ==========================================================
#                          TEST
# ==========================================================
test:
  stage: test
  image: maven:3.9.6-eclipse-temurin-17

  before_script:
    - java -version
    - mvn -version

  script:
    - mvn test

# ==========================================================
#                         PACKAGE
# ==========================================================
package:
  stage: package
  image: maven:3.9.6-eclipse-temurin-17

  before_script:
    - java -version
    - mvn -version

  script:
    - echo "Versão final detectada:"
    - mvn help:evaluate -Dexpression=project.version -q -DforceStdout

  artifacts:
    paths:
      - target/*.jar

# ==========================================================
#                         DEPLOY (DOCKER)
# ==========================================================
docker_push:
  stage: deploy
  image: docker:latest
  services:
    - docker:dind

  # NOTE: usamos uma única string multilinha (|) para garantir que
  # o GitLab interprete 'script' como uma string, evitando o erro.
  script: |
    #!/bin/sh
    set -e

    echo "Procurando o JAR em target/..."
    JAR_FILE=$(ls target/*.jar 2>/dev/null | head -n 1 || true)
    if [ -z "$JAR_FILE" ]; then
      echo "ERRO: nenhum JAR encontrado em target/. Certifique-se de que o stage build/package gerou o artefato."
      exit 1
    fi
    echo "JAR encontrado: $JAR_FILE"

    # Extrai a versão do nome do JAR (ajuste se seu padrão for diferente).
    # Exemplo de nome: meuapp-1.0.123-9f8a7c.jar
    BASENAME=$(basename "$JAR_FILE" .jar)
    # Tenta extrair a sequência após o último '-' como versão; ajuste conforme seu padrão.
    PROJECT_VERSION=$(echo "$BASENAME" | awk -F'-' '{print $NF}')
    if [ -z "$PROJECT_VERSION" ]; then
      echo "Aviso: não foi possível extrair versão do nome do JAR. Usando 'latest' como versão provisória."
      PROJECT_VERSION=latest
    fi
    echo "Versão extraída: $PROJECT_VERSION"

    # Monta tag completa da imagem
    if [ -z "$DOCKER_IMAGE_NAME" ]; then
      echo "ERRO: variável DOCKER_IMAGE_NAME não definida (Settings > CI/CD > Variables)."
      exit 1
    fi
    IMAGE_FULL_TAG="${DOCKER_IMAGE_NAME}:${PROJECT_VERSION}"
    echo "Tag final: $IMAGE_FULL_TAG"

    # Login no Docker Registry (mais seguro usando password-stdin)
    if [ -z "$DOCKER_USERNAME" ] || [ -z "$DOCKER_PASSWORD" ]; then
      echo "ERRO: DOCKER_USERNAME ou DOCKER_PASSWORD não definidos nas variáveis de CI."
      exit 1
    fi
    echo "$DOCKER_PASSWORD" | docker login -u "$DOCKER_USERNAME" --password-stdin

    # Build e push
    echo "Construindo imagem Docker..."
    docker build -t "$IMAGE_FULL_TAG" .

    echo "Enviando imagem: $IMAGE_FULL_TAG"
    docker push "$IMAGE_FULL_TAG"

    # Atualizar tag latest (opcional)
    echo "Tagueando como latest e fazendo push..."
    docker tag "$IMAGE_FULL_TAG" "${DOCKER_IMAGE_NAME}:latest"
    docker push "${DOCKER_IMAGE_NAME}:latest"

  needs:
    - package

  rules:
    - if: $CI_COMMIT_BRANCH == "master"
