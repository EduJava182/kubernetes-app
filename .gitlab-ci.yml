# ==========================================================
#             CONFIGURAÇÃO GLOBAL DO PIPELINE
# ==========================================================

# A imagem global é usada SOMENTE quando um job NÃO define sua própria imagem.
# Aqui usamos docker:latest apenas para o job de deploy.
image: docker:latest

stages:
  - build
  - test
  - package
  - deploy


# ==========================================================
#   IMPORTANTE: NÃO USAR before_script GLOBAL COM JAVA !!
# ==========================================================
# Antes você tinha:
#
# before_script:
#   - java -version
#   - mvn -version
#
# Isso é um erro pois jobs usando "docker:latest" NÃO têm Java/Maven.
# Agora cada job Maven terá seu próprio before_script.
# ==========================================================



# ==========================================================
#                       STAGE: BUILD
# ==========================================================
build:
  stage: build

  # Esta imagem TEM Java + Maven
  image: maven:3.9.6-eclipse-temurin-17

  before_script:
    - echo "Java:"
    - java -version
    - mvn -version

  script:
    - echo "Atualizando versão automaticamente..."
    - mvn versions:set -DnewVersion=1.0.$CI_PIPELINE_IID-$CI_COMMIT_SHORT_SHA
    - mvn clean package -DskipTests

  artifacts:
    paths:
      - target/*.jar
      - pom.xml



# ==========================================================
#                       STAGE: TEST
# ==========================================================
test:
  stage: test
  image: maven:3.9.6-eclipse-temurin-17

  before_script:
    - echo "Java:"
    - java -version
    - mvn -version

  script:
    - mvn test



# ==========================================================
#                       STAGE: PACKAGE
# ==========================================================
package:
  stage: package
  image: maven:3.9.6-eclipse-temurin-17

  before_script:
    - java -version
    - mvn -version

  script:
    - echo "Versão final do build:"
    - mvn help:evaluate -Dexpression=project.version -q -DforceStdout

  artifacts:
    paths:
      - target/*.jar



# ==========================================================
#                       STAGE: DEPLOY
# ==========================================================
docker_push:
  stage: deploy

  # ESSENCIAL: para poder usar docker build/push
  image: docker:latest

  services:
    - docker:dind

  # ESTE JOB NÃO USA JAVA — NÃO COLOCAR before_script AQUI!
  script:
    # 1. Obter versão do projeto
    - export PROJECT_VERSION=$(mvn help:evaluate -Dexpression=project.version -q -DforceStdout)

    # 2. Construir nome completo da imagem
    - export IMAGE_FULL_TAG=$DOCKER_IMAGE_NAME:$PROJECT_VERSION

    # 3. Login no Docker Hub
    - echo "Fazendo login no Docker Hub..."
    - docker login -u "$DOCKER_USERNAME" -p "$DOCKER_PASSWORD"

    # 4. Construir imagem Docker
    - echo "Construindo imagem: $IMAGE_FULL_TAG"
    - docker build -t $IMAGE_FULL_TAG .

    # 5. Push da imagem com versão
    - echo "Enviando imagem para o Docker Hub..."
    - docker push $IMAGE_FULL_TAG

    # 6. Push da tag latest (opcional)
    - docker tag $IMAGE_FULL_TAG $DOCKER_IMAGE_NAME:latest
    - docker push $DOCKER_IMAGE_NAME:latest

  needs:
    - package

  rules:
    # Só roda no branch master
    - if: $CI_COMMIT_BRANCH == "master"


# ==========================================================
# FIM DO ARQUIVO
# ==========================================================
