# ==========================================================
#      CONFIGURAÇÃO GLOBAL — IMAGEM PADRÃO DO PIPELINE
# ==========================================================
image: docker:latest

stages:
  - build
  - test
  - package
  - deploy

# ==========================================================
#                          BUILD
# ==========================================================
build:
  stage: build
  image: maven:3.9.6-eclipse-temurin-17
  before_script:
    - echo "Java instalado:"
    - java -version
    - echo "Maven instalado:"
    - mvn -version
  script:
    - echo "Atualizando versão automaticamente..."
    - mvn versions:set -DnewVersion=1.0.$CI_PIPELINE_IID-$CI_COMMIT_SHORT_SHA
    - mvn clean package -DskipTests
  artifacts:
    paths:
      - target/*.jar
      - pom.xml

# ==========================================================
#                          TEST
# ==========================================================
test:
  stage: test
  image: maven:3.9.6-eclipse-temurin-17
  before_script:
    - java -version
    - mvn -version
  script:
    - mvn test

# ==========================================================
#                         PACKAGE
# ==========================================================
package:
  stage: package
  image: maven:3.9.6-eclipse-temurin-17
  before_script:
    - java -version
    - mvn -version
  script:
    - echo "Versão final detectada:"
    - mvn help:evaluate -Dexpression=project.version -q -DforceStdout
  artifacts:
    paths:
      - target/*.jar

# ==========================================================
#                         DEPLOY (DOCKER)
# ==========================================================
docker_push:
  stage: deploy
  image: docker:latest
  services:
    - docker:dind
  script: |
    #!/bin/sh
    set -e

    echo "Procurando o JAR em target/..."
    JAR_FILE=$(ls target/*.jar | head -n 1)
    if [ -z "$JAR_FILE" ]; then
      echo "ERRO: nenhum JAR encontrado em target/. Certifique-se de que o stage build/package gerou o artefato."
      exit 1
    fi
    echo "JAR encontrado: $JAR_FILE"

    BASENAME=$(basename "$JAR_FILE" .jar)
    PROJECT_VERSION=$(echo "$BASENAME" | awk -F'-' '{print $NF}')
    if [ -z "$PROJECT_VERSION" ]; then
      echo "Aviso: não foi possível extrair versão. Usando 'latest'."
      PROJECT_VERSION=latest
    fi
    echo "Versão extraída: $PROJECT_VERSION"

    if [ -z "$DOCKER_IMAGE_NAME" ]; then
      echo "ERRO: variável DOCKER_IMAGE_NAME não definida."
      exit 1
    fi
    IMAGE_FULL_TAG="${DOCKER_IMAGE_NAME}:${PROJECT_VERSION}"
    echo "Tag final: $IMAGE_FULL_TAG"

    echo "$DOCKER_PASSWORD" | docker login -u "$DOCKER_USERNAME" --password-stdin

    echo "Construindo imagem Docker..."
    docker build --build-arg JAR_FILE="$JAR_FILE" -t "$IMAGE_FULL_TAG" .

    echo "Enviando imagem: $IMAGE_FULL_TAG"
    docker push "$IMAGE_FULL_TAG"

    echo "Tagueando como latest e fazendo push..."
    docker tag "$IMAGE_FULL_TAG" "${DOCKER_IMAGE_NAME}:latest"
    docker push "${DOCKER_IMAGE_NAME}:latest"
  needs:
    - package
  rules:
    - if: $CI_COMMIT_BRANCH == "master"

deploy_to_ec2:
  stage: deploy
  image: alpine:latest
  before_script:
    - apk add --no-cache openssh-client
  script:
    - echo "$EC2_KEY" > ec2_key.pem
    - chmod 600 ec2_key.pem
    - |
      ssh -o StrictHostKeyChecking=no -i ec2_key.pem $EC2_USER@$EC2_HOST << 'EOF'
        set -e
        echo "=== Conectou na EC2 ==="

        echo "=== Status do Docker antes ==="
        sudo docker ps -a || true
        sudo docker images || true

        echo "=== Atualizando Docker ==="
        sudo docker pull $DOCKER_IMAGE_NAME:latest

        echo "=== Parando container antigo ==="
        sudo docker stop meuapp || true
        sudo docker rm meuapp || true

        echo "=== Subindo container novo ==="
        sudo docker run -d --name meuapp -p 80:8080 $DOCKER_IMAGE_NAME:latest

        echo "=== Status do Docker depois ==="
        sudo docker ps -a
      EOF
  needs:
    - docker_push
  rules:
    - if: $CI_COMMIT_BRANCH == "master"
