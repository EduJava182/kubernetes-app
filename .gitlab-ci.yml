# ---------------------------
# Definição das etapas do pipeline
# O GitLab vai executar na ordem: build → test → package
# ---------------------------
stages:
  - build
  - test
  - package

# ---------------------------
# Imagem Docker usada para rodar os comandos
# Estamos usando o Maven já com JDK 17 (Temurin)
# ---------------------------
image: maven:3.9.6-eclipse-temurin-17

# ---------------------------
# Variáveis de ambiente
# Aqui definimos que o repositório Maven será baixado localmente,
# evitando downloads repetidos e acelerando o pipeline.
# ---------------------------
variables:
  MAVEN_OPTS: "-Dmaven.repo.local=.m2/repository"

# ---------------------------
# Comandos executados antes de cada stage
# Apenas para conferência (versão do Java e Maven)
# ---------------------------
before_script:
  - echo "Java:"
  - java -version
  - mvn -version

# ==========================================================
#                       STAGE: BUILD
# ==========================================================
build:
  stage: build
  script:
    # Mostra mensagem indicando que a versão será atualizada automaticamente
    - echo "Atualizando versão automaticamente..."

    # Atualiza a versão do projeto usando números do pipeline:
    #   CI_PIPELINE_IID         → número sequencial do pipeline
    #   CI_COMMIT_SHORT_SHA     → hash curto do commit
    # Exemplo de versão final gerada:
    #   1.0.34-a91b2f1
    - mvn versions:set -DnewVersion=1.0.$CI_PIPELINE_IID-$CI_COMMIT_SHORT_SHA

    # Faz o build da aplicação mas **ignora os testes**
    # (os testes rodam no stage seguinte)
    - mvn clean package -DskipTests
  artifacts:
    # Salva arquivos gerados para serem usados em stages seguintes
    paths:
      - target/*.jar     # O JAR gerado pelo Maven
      - pom.xml          # O pom atualizado com a nova versão

# ==========================================================
#                       STAGE: TEST
# ==========================================================
test:
  stage: test
  script:
    # Roda todos os testes da aplicação (JUnit)
    - mvn test

# ==========================================================
#                      STAGE: PACKAGE
# ==========================================================
package:
  stage: package
  script:
    # Exibe no terminal a versão atual do projeto
    # Exemplo de saída:
    #   1.0.34-a91b2f1
    - echo "Versão final do build:"
    - mvn help:evaluate -Dexpression=project.version -q -DforceStdout
  artifacts:
    # Salva o JAR final novamente para download pelo GitLab
    paths:
      - target/*.jar
